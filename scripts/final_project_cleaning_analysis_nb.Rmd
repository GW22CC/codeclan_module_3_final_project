---
title: "R Notebook"
output: html_notebook
---

# Final Project

## Data cleaning

```{r}
library(tidyverse)
library(janitor)
library(ggplot2)
library(infer)
library(funtimes)
library(trend)
library(GGally)

```


```{r}
# reading in cleaned data
shs_proportions_data_clean <- read_csv("../clean_data/shs_proportions_data_clean.csv")
shs_aggregate_responses_data_clean <- read_csv("../clean_data/shs_aggregate_responses_data_clean.csv")

```

```{r}
shs_aggregate_responses_data_clean %>%
  group_by(year) %>% 
  summarise(total_respondents = sum(n_persons))

```


## Analysis

### General Questions

We would like to to help us gain insights into how people feel about their local communities in Scotland. In particular, we are interested in the relationship between distance to outdoor space, and neighbourhood ratings.

    Are there certain groups that have local access to green space?
    Are there groups that are lacking access?
    What there big differences in how far people have to walk to access their green space?
    Are there any differences between rural and urban areas?
    
    How do people in neighbourhoods with good access to green space differ from those who have no good access? 
    Are there differences in how they rate their neighbourhoods? 
    Are there differences in how they rate their communities?
    
    Is there any way to predict which households would have higher ratings?


### Visualisation

Focus on age, gender, household type, simd quintiles, urban or rural, and as extension ethnicity, disabled, local authority, religion.

I am defining "local access" as 5 minutes or less because i think that seems reasonable and 11+ is open ended so could be an hour for example. Based on research I see that the 5 minute walk is used in the national indicator.

```Are there certain groups that have local access to green space (5 min or less)? Are there groups that are lacking access (10 min+)?```

## Age 

### Plots w/ Age

```{r}
shs_aggregate_responses_data_clean %>% # "Don't know" == "More than 30..", needs to be proportion to correct for diff response rates within groups, shorten cat names
  group_by(age, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(group_respondents = sum(n_persons)) %>% 
  ggplot() +
  aes(x = walking_time_to_nearest_green_or_blue_space, y = group_respondents, fill = age) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  scale_x_discrete(limits = c("A 5 minute walk or less", "Within a 6-10 minute walk", "Within an 11-20 minute walk","Within a 21-30 minute walk", "More than a 30 minute walk away", "Don't know"))

# Tom's code
# shs_responses_clean %>% 
#   group_by(distance_to_nearest_green_space) %>% 
#   count(age) %>%
#   mutate(n = n/sum(n)) %>% 
#   ggplot() + 
#   aes(x = distance_to_nearest_green_space, y = n, fill = age ) +
#   geom_col()

# shs_aggregate_responses_data_clean %>% # needs to be a proportion as varying number of annual respondents, unclear why 2012 different - olympic investment in Scotland?
#   filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
#   group_by(age, year) %>% 
#   summarise(total_respondents = sum(n_persons)) %>% 
#   ggplot() +
#   geom_line(aes(x = year, y = total_respondents, group = age, colour = age)) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#   ggtitle("Mean % of people within 5 minutes or less of green space vs. age")
# 
# shs_aggregate_responses_data_clean %>% 
#   filter(year == 2012) %>% 
#   distinct(walking_time_to_nearest_green_or_blue_space)


```

Interpretation: ***update for proportional comparisons***

Adults 35-64 years old age group have greater local access to green or blue space compared to (65+) elderly. The 16-34 year old age group generally have similar access to 35-64 however access is similar to elderly in 2015 and 2016 - currently unclear why.

The question/measure used is the time it takes to get to each area and so the distance may be the same for each age group but differences in walking speed may explain this. 

Discussion:

mean comfortable gait speed ranged from 127.2 cm/s for women in their seventies to 146.2 cm/s for men in their forties so younger on average walking 15% faster which could support idea of an artificial difference in distance.

Walking speed in elderly can be related to inactivity thus highlighting the importance of remaining active.

### Statistical testing vs. Age

Is there a significant time trend in the proportion of young people within local access to green space? 

```{r}
# library(trend)
adult_trend_test <- shs_data_clean %>%
  filter(age != "All", age == "35-64 years") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(age, year) %>% 
  summarise(mean_perc = mean(value))

adult_perc <- ts(data = adult_trend_test %>% pull(mean_perc), start=2013)
bartels.test(adult_perc)

```

```{r}
trend_test_age <- shs_data_clean %>%
  filter(age != "All", age == "35-64 years") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(year) %>% 
  arrange(year)

time <- trend_test_age %>% pull(year)
perc_means <- trend_test_age %>% pull(value)
X0 <- time + perc_means

notrend_test(X0)

```




```{r}
dist_age_test <- shs_data_clean %>% 
  filter(age != "All", age == "16-34 years", walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% 
  select(year, feature_code, value, age) %>% 
  

dist_age_test %>% 
  ggplot() +
  aes(x = year, y = value) +
  geom_point()

dist_age_test %>% 
  group_by(age, year) %>% 
  summarise(mean_val = mean(value),
            sd_val = sd(value),
            min_val = min(value),
            max_val = max(value),
            sample = n())
```

Testing the time series (year) linear trend of mean proportions within age group.

```{r}
# Testing for linear trend
notrend_test()

```


```{r}
dist_model <- dist_blue_green %>% 
  filter(measurement == "Percent", age == "35-64 years", distance_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  select(feature_code, date_code, value, gender, age, distance_to_nearest_green_or_blue_space) %>%
  group_by(date_code) %>% 
  summarise(mean_prop = mean(value)) %>% 
  ggplot() +
  aes(x = date_code, y = mean_prop) +
  geom_line()

```

### Statistical tests w/ Age

```{r}
shs_data_clean %>% 
  filter(age != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(age, year) %>% 
  summarise(mean_perc = mean(value))

# H0 - There is no difference in the mean perc of 35-64 year old vs. 65 and over access to green/blue space within 5 min walk.

shs_age_data <- shs_data_clean %>% 
  filter(age != "All", age != "16-34 years") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% 
  group_by(age, year) %>% 
  summarise(mean_perc = mean(value))

null_distribution <- shs_age_data %>% 
  specify(mean_perc ~ age) %>% # the relationship being tested
  hypothesize(null = "independence") %>% # the null hypothesis is no relationship / independent
  generate(reps = 1000, type = "permute") %>% 
  calculate(stat = "diff in means", order = c("35-64 years", "65 years and over"))

null_distribution %>% slice_min(stat, n = 5)

head(null_distribution)

observed_stat <- shs_age_data %>% 
  specify(mean_perc ~ age) %>%
  calculate(stat = "diff in means", order = c("35-64 years", "65 years and over"))

null_distribution %>%
  visualise() +
  shade_p_value(direction = "both", obs_stat = observed_stat)

null_distribution %>%
  get_p_value(direction = "both", obs_stat = observed_stat)

```



```{r}
shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(age != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "An 11 minute walk or more") %>%
  group_by(age) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = age, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(age != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "An 11 minute walk or more") %>%
  group_by(age, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = age, colour = age)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```



## Ethnicity

```{r}
shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(ethnicity != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(ethnicity) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = ethnicity, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(ethnicity != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(ethnicity, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = ethnicity, colour = ethnicity)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Interpetation:

White ethnicity have greater access than non-white and this trend is consistent albeit to varying degrees across the years 2013-2019.

```{r}
shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(ethnicity != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "An 11 minute walk or more") %>%
  group_by(ethnicity) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = ethnicity, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(ethnicity != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "An 11 minute walk or more") %>%
  group_by(ethnicity, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = ethnicity, colour = ethnicity)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


## Gender (note - these cats may have changed in recent years so review)

```{r}
shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(gender != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(gender) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = gender, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(gender != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(gender, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = gender, colour = gender)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Interpretation:

Males have greater access to local green or blue space and although this difference is marginal (~2%) it is a consitent trend across the years 2013-2019.


## Household type

```{r}
shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(household_type) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = household_type, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  #filter(gender != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(household_type, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = household_type, colour = household_type)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Interpretation:

Households with children have the greatest access to local green or blue space although this is marginally greater than adult only households. Pensions have the lowest access to local green or blue space. The trend across all household types is of decreasing access to outdoor space although the difference from start (2013) to end (2019) is marginal.

## SIMD

```{r}
shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  filter(simd_quintiles != "All") %>% 
  group_by(simd_quintiles) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = simd_quintiles, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(simd_quintiles != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(simd_quintiles, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = simd_quintiles, colour = simd_quintiles)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Interpretation:

The 80% least deprived have greater access to local green or outdoor space then the 20% most deprived on the SIMD. This is consistent across all years, 2013-2019.

## Urban or rural

```{r}
shs_data_la_join %>% 
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  filter(urban_rural_classification != "All") %>% 
  group_by(urban_rural_classification) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = urban_rural_classification, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_la_join %>% 
  #filter(measurement == "Percent") %>%
  filter(urban_rural_classification != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(urban_rural_classification, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = urban_rural_classification, colour = urban_rural_classification)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Interpretation:

Respondents living in rural areas have greater access to local green or outdoor space than respondents living in urban areas. This is consistent across all years, 2013-2019.


## Local Authority (LA)

```{r}
shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  filter(la_name != "All") %>% 
  group_by(la_name) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = la_name, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  filter(la_name != "All") %>% 
  group_by(la_name) %>% 
  summarise(mean_perc = mean(value)) %>% 
  arrange(desc(mean_perc)) %>% 
  head(5)

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(la_name, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = la_name, colour = la_name)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(legend.position = "False")

```

Interpretation:

The range of variation in access to local green or blue areas between local authority areas is ~55-85% (30%). The LA with least access is West Dunbartonshire 50.87037 and the are with greatest is East Lothian	83.92233.

```Are there big differences in how far people have to walk to access their green space?```

What is the time category proportion to green or blue space for the age groups with different access?

```{r}
shs_data_clean %>%
  filter(age != "All") %>% # want age bands
  group_by(age, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = age)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

What is the time category proportion to green or blue space for the ethnicity groups with different access?

```{r}
shs_data_clean %>%
  filter(ethnicity != "All") %>% # want age bands
  group_by(ethnicity, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = ethnicity)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

Gender

```{r}
shs_data_clean %>%
  filter(gender != "All") %>% # want age bands
  group_by(gender, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = gender)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
shs_data_clean %>%
  filter(household_type != "All") %>% # want age bands
  group_by(household_type, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = household_type)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
```{r}
shs_data_clean %>%
  filter(simd_quintiles != "All") %>% # want age bands
  group_by(simd_quintiles, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = simd_quintiles)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
```{r}
shs_data_clean %>%
  filter(urban_rural_classification != "All") %>% # want age bands
  group_by(urban_rural_classification, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = urban_rural_classification)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


For this plot to work it'll need to be with head 5 and/or tail 5 values.

```{r}
shs_data_clean %>%
  filter(age != "All") %>% # want age bands
  group_by(la_name, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = la_name)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


## Neighbourhood vs All ages

```{r}
shs_data_la_join %>% # only 446 rows
  filter(measurement == "Percent") %>%
  filter(age == "All") %>% 
  filter(!is.na(neighbourhood_rating)) %>% 
  group_by(neighbourhood_rating) %>% 
  summarise(hood_rating_count = n()) %>% 
  ggplot() +
  aes(x = neighbourhood_rating, y = hood_rating_count) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

# shs_data_la_join %>%# only 446 rows so doesn't really work
#   filter(measurement == "Percent") %>%
#   filter(age != "All") %>% 
#   filter(!is.na(neighbourhood_rating)) %>%
#   group_by(neighbourhood_rating, year) %>% 
#   summarise(hood_rating_count = n()) %>%  
#   ggplot() +
#   geom_line(aes(x = year, y = hood_rating_count, group = neighbourhood_rating, colour = neighbourhood_rating)) +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r}
# shs_data_la_join %>% # only 446 rows
#   filter(measurement == "Percent") %>%
#   filter(!is.na(household_type)) %>% 
#   group_by(neighbourhood_rating) %>% 
#   summarise(hood_rating_count = n()) %>% 
#   ggplot() +
#   aes(x = household_type, y = house_type_count) +
#   geom_col() +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```



```{r}
shs_data_la_join %>%
  filter(gender != "NA" & gender != "All") %>%
  ggplot() +
  aes(x = gender, y = local_access) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

shs_data_la_join %>%
  filter(ethnicity != "All") %>%
  ggplot() +
  aes(x = ethnicity, y = local_access) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

shs_data_la_join %>%
  filter(household_type != "All") %>%
  ggplot() +
  aes(x = household_type, y = local_access) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

shs_data_la_join %>%
  filter(simd_quintiles != "All") %>%
  ggplot() +
  aes(x = simd_quintiles, y = local_access) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 

shs_data_la_join %>% 
  distinct(urban_rural_classification)

```

What there big differences in how far people have to walk to access their green space?

```{r}
shs_data_la_join %>%
  filter(measurement == "Percent") %>%
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  filter(walking_distance_to_nearest_greenspace != "All") %>% 
  ggplot() +
  aes(x = la_name, fill = walking_distance_to_nearest_greenspace) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

Are there any differences between rural and urban areas?

```{r}
shs_data_la_join %>%
  filter(urban_rural_classification != "All") %>%
  ggplot() +
  aes(x = urban_rural_classification, y = local_access) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) 

```

```{r}
dist_blue_green %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>% 
  group_by(ethnicity, date_code) %>% 
  summarise(mean_percentage = mean(value)) %>% 
  arrange(date_code)

```

```How do people in neighbourhoods with good access to green space differ from those who have no good access? ```

```{r}
shs_data_clean %>%
  filter(age != "All") %>% # want age bands
  group_by(age, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = age)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


```{r}
shs_data_clean %>%
  #filter(household_type != "All") %>% # want age bands
  group_by(household_type, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = household_type)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r}
shs_data_clean %>%
  filter(simd_quintiles != "All") %>% # want age bands
  group_by(simd_quintiles, walking_time_to_nearest_green_or_blue_space) %>% 
  summarise(walking_time_count = mean(value)) %>% 
  ggplot(aes(x = walking_time_to_nearest_green_or_blue_space, y = walking_time_count, fill = simd_quintiles)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r}
shs_data_clean %>%
  filter(la_name == "West Lothian") %>% 
  filter(year == "2013") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less")
```

```{r}

shs_data_clean %>%
  #filter(measurement == "Percent") %>%
  filter(age != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(age) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  aes(x = age, y = mean_perc) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

shs_data_clean %>% 
  #filter(measurement == "Percent") %>%
  filter(age != "All") %>% 
  filter(walking_time_to_nearest_green_or_blue_space == "A 5 minute walk or less") %>%
  group_by(age, year) %>% 
  summarise(mean_perc = mean(value)) %>% 
  ggplot() +
  geom_line(aes(x = year, y = mean_perc, group = age, colour = age)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ggtitle("Mean % of people within 5 minutes or less of green space vs. age")


```

Community belonging exploration:

```{r}
shs_data_clean %>% 
  filter(!is.na(community_belonging)) %>% 
  

```


## Logistic Regression

Explanatory model for people who responded with "" to community belonging (across all LA authorities for all years).

```{r}
shs_data_clean %>%
  filter(community_belonging == "Very strongly") %>%
  filter(gender != "All") %>% 
  select(community_belonging, la_name, year, gender) %>% 
  distinct()
  
```

```{r}
shs_agg_resp <- read_csv("../raw_data/shs_aggregate_responses.csv")

shs_agg_resp %>% 
  filter(!is.na(nearest_green_space_use))

shs_agg_resp %>% 
  group_by(year) %>% 
  summarise(n = n())

shs_agg_resp %>% 
  distinct(volunteering_last_twelve_months)

glimpse(shs_agg_resp)

```

Q. How do people in neighbourhoods with good access to green space differ from those who have no good access?

How do people in neighbourhoods with [green space == "A 5 minute walk or less"] differ from those who have [green space > A 10 minute walk], i.e. What are the variable combinations that predict these opposite outcomes?

Explanatory model

I will use logistic regression because all the variables, predictors and outcomes, are categorical.

'local_access_to_green' will be the binary dependent variable denoting whether respondents live within a 5 minute walk of a green space.

```{r}
library(rpart)
library(rpart.plot)
library(tidyverse)

```
```{r}
head(shs_agg_resp)

```

Decision trees are slightly easier to prepare in one aspect: it’s not necessary to scale the data. 

```{r}
shs_local_green_space_access_groups_1 <- shs_agg_resp %>% 
  rename("walking_time_to_nearest_green_space" = "distance_to_nearest_green_space") %>% 
  filter(!is.na(walking_time_to_nearest_green_space)) %>% 
  mutate(local_access_to_green = if_else(walking_time_to_nearest_green_space == "A 5 minute walk or less", "Yes", "No"), .after = walking_time_to_nearest_green_space) %>% 
  select(-year, walking_time_to_nearest_green_space, n_persons) %>% # remove n_persons after duplicated rows
  mutate(community_belonging = as.factor(community_belonging),
         neighbourhood_rating = as.factor(neighbourhood_rating),
         local_access_to_green = as.factor(local_access_to_green),
         satisfaction_with_nearest_green_space = as.factor(satisfaction_with_nearest_green_space),
         age = as.factor(age),
         gender = as.factor(gender),
         economic_status = as.factor(economic_status),
         household_size = as.factor(household_size),
         highest_education_level = as.factor(highest_education_level),
         nearest_green_space_use = as.factor(nearest_green_space_use),
         volunteering_last_twelve_months = as.factor(volunteering_last_twelve_months)) %>% 
  drop_na() %>% 
  filter(n_persons == 1)

shs_local_green_space_access_groups_greater_1 <- shs_agg_resp %>% 
  
  
  rename("walking_time_to_nearest_green_space" = "distance_to_nearest_green_space") %>% 
  filter(!is.na(walking_time_to_nearest_green_space)) %>% 
  mutate(local_access_to_green = if_else(walking_time_to_nearest_green_space == "A 5 minute walk or less", "Yes", "No"), .after = walking_time_to_nearest_green_space) %>% 
  select(-year, walking_time_to_nearest_green_space, n_persons) %>% # remove n_persons after duplicated rows
  mutate(community_belonging = as.factor(community_belonging),
         neighbourhood_rating = as.factor(neighbourhood_rating),
         local_access_to_green = as.factor(local_access_to_green),
         satisfaction_with_nearest_green_space = as.factor(satisfaction_with_nearest_green_space),
         age = as.factor(age),
         gender = as.factor(gender),
         economic_status = as.factor(economic_status),
         household_size = as.factor(household_size),
         highest_education_level = as.factor(highest_education_level),
         nearest_green_space_use = as.factor(nearest_green_space_use),
         volunteering_last_twelve_months = as.factor(volunteering_last_twelve_months)) %>% 
  drop_na() %>% 
  filter(n_persons > 1) 

row_rep <- data.frame(lapply(shs_local_green_space_access_groups_greater_1, rep, shs_local_green_space_access_groups_greater_1$n_persons))

disaggregated_responses <- bind_rows(shs_local_green_space_access_groups_1, row_rep) %>% select(-c(n_persons, walking_time_to_nearest_green_space, nearest_green_space_use, satisfaaction_with_nearest_green_space))

```

```{r}
ggpairs(disaggregated_responses, columns = 1:6)
```


```{r}
ggpairs(disaggregated_responses, columns = 6:10)

```


```{r}
# get how many rows we have in total to work out the percentage
n_data <- nrow(disaggregated_responses)

# create a test sample index
test_index <- sample(1:n_data, size = n_data*0.2)

# create test set
disaggregated_responses_test  <- slice(disaggregated_responses, test_index)

# create training set
disaggregated_responses_train <- slice(disaggregated_responses, -test_index)
```

```{r}
disaggregated_responses_train %>%
 janitor::tabyl(local_access_to_green)

```

```{r}
disaggregated_responses_test %>%
 janitor::tabyl(local_access_to_green)
```

```{r}
shs_fit <- rpart(
  formula = local_access_to_green ~ ., 
  data = disaggregated_responses_train, 
  method = 'class'
)

rpart.plot(shs_fit, 
           yesno = 2, 
           fallen.leaves = TRUE, 
           faclen = 6, 
           digits = 4)

```


```{r}
glimpse(shs_local_green_space_access)

ggpairs(shs_local_green_space_access, columns = c(5, 6:12))

```

ggpairs plots show commnity_belonging, neighbourhood rating, distance to nearest green space, age, highest education level, economic status

```{r}
shs_local_green_space_access %>%
  ggplot() +
  geom_boxplot(aes(x = household_size, y = as.integer(local_access_to_green))) + 
  ylab("Good local access") + 
  scale_y_continuous(breaks=seq(0, 1,1))

```



Q. Are there differences in how they rate their neighbourhoods? 

For a given value of [access to green space: local or not local] how do people rate thir neighbourhood?

H0 - there is no difference in how people rate their neighbourhood varying with local access to green space?

Q. Are there differences in how they rate their communities?

H0 - there is no difference in how people rate their neighbourhood varying with local access to green space?

Q. Is there any way to predict which households would have higher ratings?

Decision tree - from class notes wk11 day2, "Predicting a category or numerical target value is pretty easy using decision trees."
